<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>–ö–∞—Ä—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        background-color: #222;
        font-family: sans-serif;
      }
      #container {
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      #map-container {
        position: relative;
        width: 96vw;
        max-width: 1280px;
        aspect-ratio: 1280 / 853;
        background: url("map.jpg") no-repeat center center / contain;
        border: 2px solid #444;
        user-select: none;
        margin: 0 auto;
        background-size: contain;
      }
      .character {
        position: absolute;
        width: 5vw;
        min-width: 36px;
        max-width: 64px;
        height: auto;
        aspect-ratio: 1/1;
        cursor: grab;
        transition: transform 0.1s, left 0.2s, top 0.2s;
        z-index: 2;
      }
      .character:active {
        cursor: grabbing;
        transform: scale(1.1);
      }
      #name-display {
        margin-top: 4px;
        color: #fff;
        font-size: 16px;
        min-height: 24px;
        background: #333;
        padding: 4px 12px;
        border-radius: 8px;
      }
      #lock-btn {
        margin-top: 6px;
        background: #444;
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
      }
      #lock-btn:hover {
        background: #666;
      }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  </head>
  <body>
    <div id="container">
      <div id="map-container">
        <img
          src="percy/silas.png"
          class="character"
          data-name="–°–∞–π–ª–∞—Å –ú–∞–∫–ì—Ä–æ—É"
          data-x="0.43"
          data-y="0.65"
        />
        <img
          src="percy/clement.png"
          class="character"
          data-name="–ö–ª–µ–º–µ–Ω—Ç –ì–∞—Å–∫–æ–π–Ω"
          data-x="0.16"
          data-y="0.14"
        />
        <img
          src="percy/lawrence.png"
          class="character"
          data-name="–õ–æ—Ä–µ–Ω—Å –°–∞–Ω–¥–µ—Ä—Å–æ–Ω –¢—Ä–µ—Ç–∏–π"
          data-x="0.27"
          data-y="0.23"
        />
        <img
          src="percy/blackeye.png"
          class="character"
          data-name="–ß—ë—Ä–Ω—ã–π –ì–ª–∞–∑"
          data-x="0.39"
          data-y="0.33"
        />
        <img
          src="percy/marta.png"
          class="character"
          data-name="–ú–∞—Ä—Ç–∞"
          data-x="0.27"
          data-y="0.89"
        />
        <img
          src="percy/desmon.png"
          class="character"
          data-name="–î–µ–∑–º–æ–Ω –°–∫–∏–≤—Ä–ªc"
          data-x="0.23"
          data-y="0.52"
        />
        <img
          src="percy/kanani.png"
          class="character"
          data-name="–ö–∞–Ω–∞–Ω–∏"
          data-x="0.35"
          data-y="0.61"
        />
        <img
          src="percy/Clementina.png"
          class="character"
          data-name="–ö–ª–µ–º–µ–Ω—Ç–∏–Ω–∞ –≠–∫–ª–µ—Å–∏–∞"
          data-x="0.47"
          data-y="0.71"
        />
        <img
          src="percy/Reyna.png"
          class="character"
          data-name="–†–µ–π–Ω–∞"
          data-x="0.55"
          data-y="0.12"
        />
        <img
          src="percy/Arthur.png"
          class="character"
          data-name="–ê—Ä—Ç—É—Ä –ú–æ—Ä–≥–∞–Ω"
          data-x="0.66"
          data-y="0.26"
        />
        <img
          src="percy/Faust.png"
          class="character"
          data-name="–§–∞—É—Å—Ç –ö–∞—Ä–µ–ª–ª–∞"
          data-x="0.74"
          data-y="0.40"
        />
      </div>
      <div id="name-display"></div>
      <button id="lock-btn">üîí –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyDOO7U0Usi6o93wJDBE8ooDvs_Kw-5825o",
        authDomain: "my-map-project-19aca.firebaseapp.com",
        databaseURL:
          "https://my-map-project-19aca-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "my-map-project-19aca",
        storageBucket: "my-map-project-19aca.appspot.com",
        messagingSenderId: "55009805586",
        appId: "1:55009805586:web:f4515be484191f23979fcb",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      const map = document.getElementById("map-container");
      const lockBtn = document.getElementById("lock-btn");
      const nameDisplay = document.getElementById("name-display");
      let locked = true;
      let isDragging = false;
      let dragged = null,
        offsetX = 0,
        offsetY = 0,
        mapRect = null;

      const sanitizeKey = (src) => src.replace(/[.#$/\[\]]/g, "_");

      function updateCharacterPositions() {
        mapRect = map.getBoundingClientRect();
        document.querySelectorAll(".character").forEach((char) => {
          const x = parseFloat(char.dataset.x || 0);
          const y = parseFloat(char.dataset.y || 0);
          char.style.left = x * map.offsetWidth - char.offsetWidth / 2 + "px";
          char.style.top = y * map.offsetHeight - char.offsetHeight / 2 + "px";
        });
      }

      window.addEventListener("resize", updateCharacterPositions);
      window.addEventListener("DOMContentLoaded", updateCharacterPositions);

      function loadPositions() {
        db.ref("positions_percent")
          .once("value")
          .then((snapshot) => {
            const saved = snapshot.val();
            if (saved) {
              document.querySelectorAll(".character").forEach((char) => {
                const key = sanitizeKey(char.getAttribute("src"));
                if (saved[key]) {
                  char.dataset.x = saved[key].x;
                  char.dataset.y = saved[key].y;
                }
              });
              updateCharacterPositions();
            }
          });
      }
      loadPositions();

      function savePositions() {
        const positions = {};
        document.querySelectorAll(".character").forEach((char) => {
          const key = sanitizeKey(char.getAttribute("src"));
          positions[key] = {
            x: char.dataset.x,
            y: char.dataset.y,
          };
        });
        db.ref("positions_percent").set(positions);
      }

      document.querySelectorAll(".character").forEach((char) => {
        char.addEventListener("mousedown", (e) => {
          if (locked) return;
          isDragging = true;
          dragged = char;
          mapRect = map.getBoundingClientRect();
          offsetX = e.clientX - dragged.getBoundingClientRect().left;
          offsetY = e.clientY - dragged.getBoundingClientRect().top;
        });

        char.addEventListener("mouseover", () => {
          nameDisplay.textContent = char.dataset.name;
        });
        char.addEventListener("mouseout", () => {
          nameDisplay.textContent = "";
        });
      });

      document.addEventListener("mousemove", (e) => {
        if (!isDragging || !dragged || locked) return;
        const xPx =
          e.clientX - mapRect.left - offsetX + dragged.offsetWidth / 2;
        const yPx =
          e.clientY - mapRect.top - offsetY + dragged.offsetHeight / 2;

        const minX = dragged.offsetWidth / 2;
        const maxX = map.offsetWidth - dragged.offsetWidth / 2;
        const minY = dragged.offsetHeight / 2;
        const maxY = map.offsetHeight - dragged.offsetHeight / 2;
        const cx = Math.max(minX, Math.min(maxX, xPx));
        const cy = Math.max(minY, Math.min(maxY, yPx));

        let percentX = cx / map.offsetWidth;
        let percentY = cy / map.offsetHeight;
        dragged.dataset.x = percentX;
        dragged.dataset.y = percentY;
        dragged.style.left = cx - dragged.offsetWidth / 2 + "px";
        dragged.style.top = cy - dragged.offsetHeight / 2 + "px";
      });

      document.addEventListener("mouseup", () => {
        if (isDragging && dragged) {
          savePositions();
          isDragging = false;
          dragged = null;
        }
      });

      lockBtn.addEventListener("click", () => {
        if (locked) {
          const pass = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:");
          if (pass === "1234") {
            locked = false;
            lockBtn.textContent = "üîì –ó–∞–∫—Ä–µ–ø–∏—Ç—å";
          } else {
            alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
          }
        } else {
          locked = true;
          lockBtn.textContent = "üîí –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å";
        }
      });
    </script>
  </body>
</html>
